image: salamandar/archlinux-gimp:latest

stages:
  - gimp

variables:
  INSTALL_DIR: "_install"
  INSTALL_PREFIX: "${CI_PROJECT_DIR}/${INSTALL_DIR}"
  PACMAN_CACHE:   "${CI_PROJECT_DIR}/_pacman_cache"

cache:
  paths:
  - _pacman_cache


# build-min-autotools:
#   extends: .gimp-autotools
#   dependencies:
#     - babl-git
#     - gegl-git

# build-min-meson:
#   extends: .gimp-meson
#   dependencies:
#     - babl-min
#     - gegl-min

.gimp-x86_64-w64-mingw32-base:
  stage: gimp
  artifacts:
    paths:
    - "${INSTALL_DIR}"
  before_script:
    - pacman -Syu --noconfirm --needed --cachedir "${PACMAN_CACHE}"
        git
        base-devel
        python-docutils
        python-pip
    - curl https://aur.archlinux.org/cgit/aur.git/snapshot/mingw-w64-gcc.tar.gz --output mingw-w64-gcc.tar.gz
    - tar xzf mingw-w64-gcc.tar.gz
    - cd mingw-w64-gcc
    - makepkg -si
    - pip3 install crossroad

build-git-x86_64-w64-mingw32-meson:
  extends: .gimp-x86_64-w64-mingw32-base
  script:
    - crossroad w64 gimp --run="build/windows/crossbuild-gitlab-ci.sh"
  artifacts:
    name: "app-tests-logs-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    when: on_failure
    expire_in: 1 week
    paths:
      - _build/
